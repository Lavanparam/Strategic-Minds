<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Minds | Midnight Edition v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Marked.js for rendering Gemini's Markdown responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-deep: #0a0a0c;
            --card-bg: #141417;
            --accent-primary: #6366f1;
            --accent-success: #10b981;
            --accent-danger: #f43f5e;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg-deep);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .glass {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(12px);
        }

        .neon-glow-indigo { box-shadow: 0 0 25px rgba(99, 102, 241, 0.1); }
        
        .chart-container { position: relative; width: 100%; height: 260px; }

        /* Styling for Rendered Markdown from Gemini */
        .prose-dark h1, .prose-dark h2, .prose-dark h3 { color: #818cf8; font-weight: 800; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.25rem; }
        .prose-dark p { margin-bottom: 1rem; color: #cbd5e1; }
        .prose-dark ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #94a3b8; }
        .prose-dark strong { color: #fff; }
        .prose-dark code { font-family: 'JetBrains Mono', monospace; background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem; border-radius: 4px; color: #f43f5e; }

        .loader {
            width: 18px; height: 18px;
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .fade-transition { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500/30">

    <nav class="sticky top-0 z-50 glass border-b border-white/5 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center font-bold text-white shadow-lg">Œ£</div>
                <span class="text-xl font-extrabold tracking-tighter uppercase">Strategic <span class="text-indigo-500">Minds</span></span>
            </div>
            <div class="flex space-x-1 bg-black/40 p-1 rounded-xl border border-white/5">
                <button onclick="switchTab('sim')" id="tab-sim" class="px-5 py-2 rounded-lg text-sm font-semibold transition bg-indigo-600 text-white shadow-lg">Simulation</button>
                <button onclick="switchTab('library')" id="tab-library" class="px-5 py-2 rounded-lg text-sm font-semibold transition text-gray-400 hover:text-white">Library</button>
                <button onclick="switchTab('lab')" id="tab-lab" class="px-5 py-2 rounded-lg text-sm font-semibold transition text-gray-400 hover:text-white">AI Lab</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10 space-y-10">
        
        <!-- SECTION: SIMULATION -->
        <div id="view-sim" class="space-y-8 animate-in fade-in duration-500">
            
            <!-- Dynamic Briefing Panel -->
            <div id="game-briefing" class="glass p-8 rounded-[2rem] border-l-4 border-l-indigo-500 bg-gradient-to-r from-indigo-500/5 to-transparent">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                    <div class="space-y-2">
                        <div class="text-xs font-bold text-indigo-400 uppercase tracking-[0.2em]">Strategic Briefing</div>
                        <h2 id="briefing-title" class="text-3xl font-black text-white">Prisoner's Dilemma</h2>
                        <p id="briefing-desc" class="text-gray-400 max-w-2xl leading-relaxed">The classical model of cooperation. Two suspects are interrogated separately. Will you remain silent or betray your partner?</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 bg-black/40 p-4 rounded-2xl border border-white/5">
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">ü§ù Cooperate</div>
                            <div id="briefing-coop" class="text-xs text-emerald-400 font-medium italic">"Stay Silent"</div>
                        </div>
                        <div class="border-l border-white/10 pl-4">
                            <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">‚öîÔ∏è Defect</div>
                            <div id="briefing-defect" class="text-xs text-rose-400 font-medium italic">"Betray Accomplice"</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Controls & Stats -->
                <div class="lg:col-span-3 space-y-6">
                    <div class="glass p-6 rounded-2xl space-y-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Global Protocol</h3>
                        <select id="game-selector" onchange="updateGameContext()" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="pd">Prisoner's Dilemma</option>
                            <option value="chicken">Game of Chicken</option>
                            <option value="staghunt">Stag Hunt</option>
                        </select>
                        
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest pt-4">Opponent Profile</h3>
                        <select id="strat-selector" onchange="resetGame()" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="titfortat">Tit-for-Tat (Reciprocal)</option>
                            <option value="grudger">Grim Trigger (Unforgiving)</option>
                            <option value="always_defect">Always Defect (Cynic)</option>
                            <option value="random">Pure Random (Agent of Chaos)</option>
                        </select>
                    </div>

                    <div class="glass p-6 rounded-2xl">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-[10px] text-gray-500 uppercase font-bold">Player</div>
                                <div id="p1-score" class="text-3xl font-black text-indigo-400">0</div>
                            </div>
                            <div class="text-center border-l border-white/10">
                                <div class="text-[10px] text-gray-500 uppercase font-bold">Bot</div>
                                <div id="p2-score" class="text-3xl font-black text-rose-400">0</div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/5 text-center flex justify-between items-center">
                            <span class="text-[10px] text-gray-500 uppercase font-bold">Rounds</span>
                            <span id="round-count" class="text-sm font-bold text-white">0</span>
                        </div>
                    </div>
                </div>

                <!-- Simulation Visuals -->
                <div class="lg:col-span-6 space-y-8">
                    <div class="glass p-8 rounded-[2.5rem] neon-glow-indigo relative flex flex-col items-center justify-center min-h-[300px]">
                        <div id="outcome-banner" class="mb-10 text-center h-12 flex items-center justify-center font-semibold text-indigo-100 text-lg">
                            Ready for initialization.
                        </div>

                        <div class="flex space-x-8">
                            <button onclick="playRound('cooperate')" class="group flex flex-col items-center space-y-4">
                                <div class="w-24 h-24 bg-emerald-500/5 border border-emerald-500/20 rounded-3xl flex items-center justify-center text-4xl group-hover:bg-emerald-500 group-hover:text-white transition-all duration-500 group-hover:scale-110">ü§ù</div>
                                <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-emerald-500/60 group-hover:text-emerald-400">Cooperate</span>
                            </button>
                            <button onclick="playRound('defect')" class="group flex flex-col items-center space-y-4">
                                <div class="w-24 h-24 bg-rose-500/5 border border-rose-500/20 rounded-3xl flex items-center justify-center text-4xl group-hover:bg-rose-500 group-hover:text-white transition-all duration-500 group-hover:scale-110">‚öîÔ∏è</div>
                                <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-rose-500/60 group-hover:text-rose-400">Defect</span>
                            </button>
                        </div>
                    </div>

                    <div class="glass p-6 rounded-3xl">
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis -->
                <div class="lg:col-span-3">
                    <div class="glass p-6 rounded-3xl border-indigo-500/20 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest flex items-center">
                                <span class="mr-2">‚ú®</span> Strategist
                            </h3>
                            <div id="ai-status" class="hidden"><div class="loader"></div></div>
                        </div>
                        
                        <!-- AI Response Container (Markdown Rendered) -->
                        <div id="ai-response-box" class="flex-grow prose-dark text-xs overflow-y-auto max-h-[450px] pr-2 scroll-smooth">
                            <p class="italic text-gray-500">History threshold: 5 rounds required for pattern analysis.</p>
                        </div>

                        <button id="analyze-btn" disabled onclick="requestAIAnalysis()" class="mt-6 w-full py-4 bg-indigo-600/10 hover:bg-indigo-600 hover:text-white disabled:opacity-20 border border-indigo-500/30 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all">
                            Run Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: LIBRARY & LAB (Simplified UI) -->
        <div id="view-library" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8 animate-in slide-in-from-bottom-5 duration-500">
             <!-- Library content here -->
        </div>

        <div id="view-lab" class="hidden animate-in slide-in-from-bottom-5 duration-500">
            <div class="max-w-4xl mx-auto glass p-10 rounded-[3rem] space-y-8 shadow-2xl">
                <div class="space-y-2">
                    <h2 class="text-3xl font-black">Scenario Laboratory</h2>
                    <p class="text-gray-500">Describe a conflict to identify its game-theoretic properties.</p>
                </div>
                <textarea id="lab-input" placeholder="e.g., A developer deciding to share code vs. patenting it..." 
                    class="w-full h-48 bg-black/60 border border-white/10 rounded-3xl p-8 text-gray-200 focus:ring-4 focus:ring-indigo-500/20 outline-none transition resize-none text-lg"></textarea>
                
                <div class="flex justify-between items-center">
                    <button onclick="generateRandomScenario()" class="text-xs text-gray-500 hover:text-white transition">Need inspiration?</button>
                    <button id="lab-submit" onclick="runLabAnalysis()" class="px-12 py-5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-2xl transition shadow-xl shadow-indigo-500/20 flex items-center">
                        <span id="lab-loader" class="loader mr-3 hidden"></span> Map Strategic Matrix
                    </button>
                </div>

                <div id="lab-result" class="mt-10 bg-black/50 rounded-3xl p-8 border border-white/10 hidden prose-dark">
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- GAME DATA ---
        const gameBriefings = {
            pd: {
                title: "Prisoner's Dilemma",
                desc: "Two accomplices are held in separate cells. If both stay silent, they get light sentences. If one betrays the other, they go free while the other gets maximum time. If both betray, both get heavy sentences.",
                coop: "Remain Silent",
                defect: "Betray Partner"
            },
            chicken: {
                title: "Game of Chicken",
                desc: "Two drivers head toward each other at high speed. The first to swerve is the 'Chicken'. If neither swerves, they crash. It is a game of brinkmanship where yielding is safe but costs prestige.",
                coop: "Swerve (Safe)",
                defect: "Stay Straight (Aggressive)"
            },
            staghunt: {
                title: "Stag Hunt",
                desc: "Hunters must trust each other to stay at their posts to catch a large Stag. If one leaves to catch a Rabbit (guaranteed but small), the Stag escapes and the remaining hunters get nothing.",
                coop: "Hunt the Stag (Trust)",
                defect: "Catch a Rabbit (Self-Interest)"
            }
        };

        const PAYOFFS = {
            pd: { cc: [3,3], dd: [1,1], cd: [0,5], dc: [5,0] },
            chicken: { cc: [0,0], dd: [-10,-10], cd: [-1,1], dc: [1,-1] },
            staghunt: { cc: [5,5], dd: [2,2], cd: [0,3], dc: [3,0] }
        };

        let gameState = { round: 0, p1Score: 0, p2Score: 0, history: [] };
        let chart = null;

        // --- CORE FUNCTIONS ---

        function updateGameContext() {
            const gameType = document.getElementById('game-selector').value;
            const context = gameBriefings[gameType];
            
            // Update UI with fade effect
            const briefing = document.getElementById('game-briefing');
            briefing.style.opacity = '0.5';
            
            setTimeout(() => {
                document.getElementById('briefing-title').innerText = context.title;
                document.getElementById('briefing-desc').innerText = context.desc;
                document.getElementById('briefing-coop').innerText = `"${context.coop}"`;
                document.getElementById('briefing-defect').innerText = `"${context.defect}"`;
                briefing.style.opacity = '1';
                resetGame();
            }, 200);
        }

        function switchTab(tab) {
            ['sim', 'library', 'lab'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = "px-5 py-2 rounded-lg text-sm font-semibold transition text-gray-400 hover:text-white";
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = "px-5 py-2 rounded-lg text-sm font-semibold transition bg-indigo-600 text-white shadow-lg";
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'You', data: [], borderColor: '#6366f1', borderWidth: 3, tension: 0.4, fill: false, pointRadius: 0 },
                        { label: 'Bot', data: [], borderColor: '#f43f5e', borderWidth: 2, borderDash: [5, 5], tension: 0.4, fill: false, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#444' } },
                        x: { grid: { display: false }, ticks: { color: '#444' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function playRound(move) {
            const gameType = document.getElementById('game-selector').value;
            const strat = document.getElementById('strat-selector').value;
            const lastRound = gameState.history[gameState.history.length - 1];

            let botMove = 'cooperate';
            if (strat === 'random') botMove = Math.random() > 0.5 ? 'cooperate' : 'defect';
            else if (strat === 'always_defect') botMove = 'defect';
            else if (strat === 'titfortat') botMove = lastRound ? lastRound.p1 : 'cooperate';
            else if (strat === 'grudger') botMove = gameState.history.some(h => h.p1 === 'defect') ? 'defect' : 'cooperate';

            const key = (move === 'cooperate' ? 'c' : 'd') + (botMove === 'cooperate' ? 'c' : 'd');
            const pts = PAYOFFS[gameType][key];

            gameState.round++;
            gameState.p1Score += pts[0];
            gameState.p2Score += pts[1];
            gameState.history.push({ p1: move, p2: botMove });

            updateUI(move, botMove, pts);
        }

        function updateUI(m1, m2, pts) {
            document.getElementById('p1-score').innerText = gameState.p1Score;
            document.getElementById('p2-score').innerText = gameState.p2Score;
            document.getElementById('round-count').innerText = gameState.round;

            const banner = document.getElementById('outcome-banner');
            banner.innerHTML = `<span class="${m1==='cooperate'?'text-emerald-400':'text-rose-400'}">${m1.toUpperCase()}</span> vs <span class="${m2==='cooperate'?'text-emerald-400':'text-rose-400'}">${m2.toUpperCase()}</span> <span class="mx-4 text-gray-700">/</span> <span class="text-white">+${pts[0]}pts</span>`;

            chart.data.labels.push(gameState.round);
            chart.data.datasets[0].data.push(gameState.p1Score);
            chart.data.datasets[1].data.push(gameState.p2Score);
            chart.update();

            if (gameState.round >= 5) document.getElementById('analyze-btn').disabled = false;
        }

        function resetGame() {
            gameState = { round: 0, p1Score: 0, p2Score: 0, history: [] };
            document.getElementById('p1-score').innerText = '0';
            document.getElementById('p2-score').innerText = '0';
            document.getElementById('round-count').innerText = '0';
            document.getElementById('outcome-banner').innerText = "Waiting for protocol start...";
            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('ai-response-box').innerHTML = `<p class="italic text-gray-500 text-[10px]">History threshold: 5 rounds required.</p>`;
            
            if (chart) {
                chart.data.labels = [];
                chart.data.datasets.forEach(d => d.data = []);
                chart.update();
            }
        }

        // --- AI API CALLS (Using Proxy) ---

        async function secureAIRequest(prompt, system) {
            document.getElementById('ai-status').classList.remove('hidden');
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, systemInstruction: system })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (err) {
                return "## Error\nUnable to reach backend. Verify `api/generate.js` deployment.";
            } finally {
                document.getElementById('ai-status').classList.add('hidden');
            }
        }

        async function requestAIAnalysis() {
            const gameType = document.getElementById('game-selector').value;
            const hStr = gameState.history.map(r => `${r.p1[0]}:${r.p2[0]}`).join(', ');
            const system = "You are a Strategic Mastermind. Review move history. Identify player archetype. Give 3 short, actionable bullet points to win. Use Markdown.";
            const prompt = `Game: ${gameBriefings[gameType].title}. History (Me:Bot): ${hStr}`;
            
            const box = document.getElementById('ai-response-box');
            box.innerHTML = '<div class="loader"></div>';
            
            const markdown = await secureAIRequest(prompt, system);
            box.innerHTML = marked.parse(markdown);
        }

        async function runLabAnalysis() {
            const input = document.getElementById('lab-input').value;
            if (!input.trim()) return;

            const resBox = document.getElementById('lab-result');
            const loader = document.getElementById('lab-loader');
            
            resBox.classList.remove('hidden');
            resBox.innerHTML = '<div class="flex justify-center p-10"><div class="loader"></div></div>';
            loader.classList.remove('hidden');

            const system = "Analyze this conflict. 1. Model Name. 2. Define Payoffs (Matrix style description). 3. Optimal Strategy. 4. Real-world analogy. Use bold headers and clean Markdown.";
            const result = await secureAIRequest(input, system);
            
            resBox.innerHTML = marked.parse(result);
            loader.classList.add('hidden');
        }

        function generateRandomScenario() {
            const prompts = [
                "A coffee shop and a bookstore sharing a wall decide whether to install a shared garden.",
                "Two nations negotiating fishing rights in a disappearing ocean zone.",
                "A startup founder deciding whether to take VC money (aggressive growth) or bootstrap (safety).",
                "Siblings deciding who cleans the kitchen after a massive holiday party."
            ];
            document.getElementById('lab-input').value = prompts[Math.floor(Math.random()*prompts.length)];
        }

        window.onload = initChart;
    </script>
</body>
</html>
